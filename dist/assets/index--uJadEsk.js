import{r as a,E as e,_ as k,$ as B,a9 as R,J as W,I as G,L as Q,a0 as y,Z as X}from"./index-DM-CIWAp.js";import{C as Z}from"./Card-Cs5NGpgY.js";import{I as q}from"./Input-C5fRLLhS.js";import{B as g}from"./Button-CSkHMulG.js";import{M as Y}from"./Modal-vVolvInd.js";import{L as ee,S as se,C as te,a as ae}from"./star-DNP2yKMj.js";import{C as re}from"./clipboard-list-2eVWPQ9h.js";import{F as le}from"./file-x-DcB5xnML.js";import{C as ne}from"./ConfirmationModal-K-Eb6b0a.js";import{S as oe}from"./search-CuRiBKad.js";import{P as de}from"./plus-Bdy1EMzm.js";import{U as ie}from"./user-plus-BtFWmKrL.js";import{E as ce}from"./eye-DucQexOi.js";import{S as me}from"./square-pen-Ctp6C1gD.js";import{T as xe}from"./trash-2-BDU6yBnr.js";import{A as pe}from"./arrow-up-down-quOBe8kM.js";import{C as he}from"./CustomerFormModal-CiANoQqz.js";const ue=[{id:1,date:"2023-10-26",type:"Email",notes:"Sent a follow-up email about the new design."},{id:2,date:"2023-10-24",type:"Call",notes:"Discussed the project timeline and budget."}],ge=({customerId:i})=>{const[m,c]=a.useState(ue),[n,d]=a.useState({type:"Call",notes:""}),p=()=>{if(n.notes.trim()==="")return;const r={id:Date.now(),date:new Date().toISOString().split("T")[0],type:n.type,notes:n.notes};c([r,...m]),d({type:"Call",notes:""})};return e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow mt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Communication Log"}),e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsxs("select",{value:n.type,onChange:r=>d({...n,type:r.target.value}),className:"px-3 py-2 border border-gray-300 rounded-md",children:[e.jsx("option",{children:"Call"}),e.jsx("option",{children:"Email"}),e.jsx("option",{children:"WhatsApp"}),e.jsx("option",{children:"Meeting"})]}),e.jsx("textarea",{value:n.notes,onChange:r=>d({...n,notes:r.target.value}),placeholder:"Add a note...",rows:2,className:"flex-grow p-2 border border-gray-300 rounded-md"}),e.jsx("button",{onClick:p,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Log"})]}),e.jsx("div",{className:"space-y-3",children:m.map(r=>e.jsxs("div",{className:"p-3 bg-gray-50 rounded-md",children:[e.jsxs("p",{className:"font-semibold",children:[r.type," on ",r.date]}),e.jsx("p",{className:"text-gray-600",children:r.notes})]},r.id))})]})},fe=({customerId:i,customerName:m,isOpen:c,onClose:n})=>{const[d,p]=a.useState([]),[r,h]=a.useState([]),[f,N]=a.useState([]),[x,C]=a.useState(!1),[u,S]=a.useState(null),[l,b]=a.useState("orders"),v=a.useCallback(async()=>{if(!(!i||l==="communication")){C(!0),S(null);try{if(l==="orders"){const{data:o,error:t}=await k.from("order_summary_with_dues").select("order_id, total_amount, status, date").eq("customer_id",i).order("date",{ascending:!1});if(t)throw t;p(o||[])}else if(l==="payments"){const{data:o,error:t}=await k.from("payments").select("id, order_id, amount_paid, payment_method, created_at").eq("customer_id",i).order("created_at",{ascending:!1});if(t)throw t;h(o||[])}else if(l==="whatsapp"){const{data:o,error:t}=await k.from("whatsapp_log").select("id, phone, message, template_name, sent_at").eq("customer_id",i).order("sent_at",{ascending:!1});if(t)throw t;N(o||[])}}catch(o){console.error(`Error fetching ${l} for customer:`,o),S(o.message||`An unknown error occurred while fetching ${l}.`)}finally{C(!1)}}},[i,l]);a.useEffect(()=>{c&&v()},[c,i,l,v]);const L=()=>{if(x)return e.jsx("div",{className:"flex justify-center items-center py-10",children:e.jsx(W,{className:"w-8 h-8 animate-spin text-primary-500"})});if(u)return e.jsxs("div",{className:"py-10 text-center text-red-600",children:[e.jsx(G,{className:"mx-auto h-8 w-8 mb-2"}),e.jsx("p",{children:u})]});switch(l){case"orders":return d.length===0?e.jsxs("div",{className:"text-center py-10 text-gray-500",children:[e.jsx(le,{className:"mx-auto h-10 w-10 mb-2"}),e.jsx("p",{children:"No orders found for this customer."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:"Order #"}),e.jsx("th",{className:"px-4 py-2",children:"Total"}),e.jsx("th",{className:"px-4 py-2",children:"Status"}),e.jsx("th",{className:"px-4 py-2",children:"Date"}),e.jsx("th",{className:"px-4 py-2"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:d.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsxs("td",{className:"px-4 py-2 font-medium",children:["#",t.order_id]}),e.jsxs("td",{className:"px-4 py-2",children:["₹",t.total_amount.toLocaleString("en-IN")]}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("span",{className:`px-2 py-1 text-xs rounded-full font-medium ${t.status==="Delivered"?"bg-green-100 text-green-700":"bg-red-100 text-red-700"}`,children:t.status||"N/A"})}),e.jsx("td",{className:"px-4 py-2",children:new Date(t.date).toLocaleDateString("en-GB")}),e.jsx("td",{className:"px-4 py-2 text-right",children:e.jsx(Q,{to:`/invoices/${t.order_id}`,children:e.jsx(g,{variant:"link",size:"sm",children:"View Invoice"})})})]},t.order_id))})]})});case"payments":return r.length===0?e.jsxs("div",{className:"text-center py-10 text-gray-500",children:[e.jsx(B,{className:"mx-auto h-10 w-10 mb-2"}),e.jsx("p",{children:"No payment records found."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:"Payment ID"}),e.jsx("th",{className:"px-4 py-2",children:"Order #"}),e.jsx("th",{className:"px-4 py-2",children:"Amount Paid"}),e.jsx("th",{className:"px-4 py-2",children:"Method"}),e.jsx("th",{className:"px-4 py-2",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:r.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-2 max-w-xs truncate",children:t.id}),e.jsxs("td",{className:"px-4 py-2",children:["#",t.order_id]}),e.jsxs("td",{className:"px-4 py-2",children:["₹",t.amount_paid.toLocaleString("en-IN")]}),e.jsx("td",{className:"px-4 py-2",children:t.payment_method||"-"}),e.jsx("td",{className:"px-4 py-2",children:new Date(t.created_at).toLocaleDateString("en-GB")})]},t.id))})]})});case"whatsapp":return f.length===0?e.jsxs("div",{className:"text-center py-10 text-gray-500",children:[e.jsx(R,{className:"mx-auto h-10 w-10 mb-2"}),e.jsx("p",{children:"No WhatsApp logs found."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full table-auto text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2",children:"Phone"}),e.jsx("th",{className:"px-4 py-2",children:"Message"}),e.jsx("th",{className:"px-4 py-2",children:"Template"}),e.jsx("th",{className:"px-4 py-2",children:"Date"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:f.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-2",children:t.phone}),e.jsx("td",{className:"px-4 py-2 max-w-xs truncate",children:t.message}),e.jsx("td",{className:"px-4 py-2",children:t.template_name||"-"}),e.jsx("td",{className:"px-4 py-2",children:new Date(t.sent_at).toLocaleDateString("en-GB")})]},t.id))})]})});case"communication":const o=parseInt(i,10);return isNaN(o)?e.jsx("div",{className:"text-center py-10 text-red-500",children:"Invalid Customer ID"}):e.jsx(ge,{customerId:o});default:return null}};return e.jsxs(Y,{isOpen:c,onClose:n,title:`Customer Details: ${m}`,size:"3xl",children:[e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-6 overflow-x-auto",children:[e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${l==="orders"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("orders"),children:[e.jsx(ee,{size:16})," Orders"]}),e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${l==="payments"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("payments"),children:[e.jsx(B,{size:16})," Payments"]}),e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${l==="whatsapp"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("whatsapp"),children:[e.jsx(R,{size:16})," WhatsApp Logs"]}),e.jsxs("button",{className:`flex items-center gap-2 px-1 py-3 text-sm font-medium whitespace-nowrap border-b-2 ${l==="communication"?"border-primary-600 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700"}`,onClick:()=>b("communication"),children:[e.jsx(re,{size:16})," Communication Log"]})]})}),e.jsx("div",{children:L()})]})},je=()=>{const i=()=>{try{const d=["Name,Email,Phone,Address,JoinedDate,Tags",...["John Doe,john@example.com,123-456-7890,123 Main St,2023-01-15,VIP;New","Jane Smith,jane@example.com,987-654-3210,456 Oak Ave,2023-02-20,Wholesale"]].join(`
`),p="data:text/csv;charset=utf-8,"+encodeURIComponent(d),r=document.createElement("a");r.setAttribute("href",p),r.setAttribute("download","customers.csv"),document.body.appendChild(r),r.click(),document.body.removeChild(r),y.success("Customer data exported!")}catch(c){console.error("Failed to export customers:",c),y.error("Could not export customer data.")}},m=c=>{var d;const n=(d=c.target.files)==null?void 0:d[0];n&&y.success(`File "${n.name}" selected. Import processing would happen here.`)};return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("label",{className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 cursor-pointer text-sm font-medium",children:[e.jsx("span",{children:"Import"}),e.jsx("input",{type:"file",className:"hidden",accept:".csv",onChange:m})]}),e.jsx("button",{onClick:i,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium",children:"Export"})]})},z=10,ye=({onAdd:i,onEdit:m,onDataChange:c})=>{const{userProfile:n}=X(),[d,p]=a.useState([]),[r,h]=a.useState(!0),[f,N]=a.useState(null),[x,C]=a.useState(""),[u,S]=a.useState(""),[l,b]=a.useState("joined_date"),[v,L]=a.useState("desc"),[o,t]=a.useState(1),[T,J]=a.useState(0),[D,I]=a.useState(null),[_,$]=a.useState(null),[M,A]=a.useState(!1);a.useEffect(()=>{t(1)},[x,u,l,v]);const F=a.useCallback(async()=>{h(!0),N(null);try{let s=k.from("customer_summary").select("*",{count:"exact"});x&&(s=s.or(`name.ilike.%${x}%,phone.ilike.%${x}%,email.ilike.%${x}%`)),u&&(s=s.contains("tags",[u])),s=s.order(l,{ascending:v==="asc"});const j=(o-1)*z,w=j+z-1;s=s.range(j,w);const{data:H,error:O,count:K}=await s;if(O)throw O;p(H||[]),J(K||0)}catch(s){N(`Failed to load customers: ${s.message}`),y.error("Failed to load customers.")}finally{h(!1)}},[x,u,l,v,o]);a.useEffect(()=>{F()},[F,c]);const P=Math.ceil(T/z),U=s=>{if(!n||n.role!=="Owner"){y.error("Permission denied: Only Owners can delete customers.");return}$(s),A(!0)},V=async()=>{if(_){h(!0);try{const{error:s}=await k.rpc("delete_customer_and_related_data",{customer_id_to_delete:_.id});if(s)throw s;y.success("Customer deleted successfully!"),c(),A(!1),$(null)}catch(s){y.error(`Failed to delete customer: ${s.message}`)}finally{h(!1)}}},E=({field:s,children:j})=>e.jsxs("button",{onClick:()=>{b(s),L(w=>l===s&&w==="asc"?"desc":"asc")},className:"flex items-center gap-1 text-muted-foreground hover:text-foreground",children:[j,e.jsx(pe,{size:14,className:l===s?"text-primary":""})]});return e.jsxs(Z,{children:[e.jsxs("div",{className:"p-4 border-b space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{className:"relative w-full sm:w-1/3",children:[e.jsx(oe,{className:"w-4 h-4 text-muted-foreground absolute top-1/2 left-3 -translate-y-1/2"}),e.jsx(q,{id:"search-customers",placeholder:"Search by name, phone, or email...",value:x,onChange:s=>C(s.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{}),e.jsxs(g,{onClick:i,size:"sm",className:"w-full sm:w-auto",children:[e.jsx(de,{className:"w-4 h-4 mr-2"})," Add New Customer"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(q,{id:"tag-filter",label:"Filter by Tag",placeholder:"e.g., VIP, Wholesale",value:u,onChange:s=>S(s.target.value)}),e.jsx(g,{onClick:()=>{C(""),S("")},variant:"outline",className:"self-end",children:"Clear Filters"})]})]}),r?e.jsxs("div",{className:"flex justify-center items-center py-12",children:[e.jsx(W,{className:"w-8 h-8 animate-spin text-primary"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Loading customers..."})]}):f?e.jsxs("div",{className:"p-6 bg-destructive/10 text-destructive text-center",children:[e.jsx(G,{className:"w-10 h-10 mx-auto mb-2"}),e.jsx("p",{className:"font-semibold",children:"Error Loading Customers"}),e.jsx("p",{className:"text-sm",children:f})]}):d.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ie,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"font-semibold text-lg",children:"No customers found."}),e.jsx("p",{className:"text-sm",children:"Try adjusting your filters or add a new customer."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:e.jsx(E,{field:"name",children:"Customer"})}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:"Contact"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:"Tags"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-muted-foreground",children:e.jsx(E,{field:"total_orders",children:"Orders"})}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-muted-foreground",children:e.jsx(E,{field:"balance_due",children:"Balance Due"})}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-muted-foreground",children:e.jsx(E,{field:"joined_date",children:"Joined"})}),e.jsx("th",{className:"px-4 py-3 text-center font-medium text-muted-foreground",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y",children:d.map(s=>{var j;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-4 py-3 font-medium text-foreground flex items-center gap-2",children:[s.total_paid>1e4&&e.jsx(se,{size:14,className:"text-yellow-500 fill-current",title:"Premium Customer"}),s.name]}),e.jsxs("td",{className:"px-4 py-3 text-muted-foreground",children:[e.jsx("div",{children:s.phone}),e.jsx("div",{className:"text-xs",children:s.email})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"flex flex-wrap gap-1",children:(j=s.tags)==null?void 0:j.map(w=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded-full bg-secondary text-secondary-foreground",children:w},w))})}),e.jsx("td",{className:"px-4 py-3 text-right text-foreground",children:s.total_orders||0}),e.jsxs("td",{className:`px-4 py-3 text-right font-bold ${s.balance_due>0?"text-red-600":"text-green-600"}`,children:["₹",(s.balance_due||0).toLocaleString("en-IN")]}),e.jsx("td",{className:"px-4 py-3 text-muted-foreground",children:new Date(s.joined_date).toLocaleDateString("en-GB")}),e.jsxs("td",{className:"px-4 py-3 text-center space-x-1",children:[e.jsx(g,{variant:"ghost",size:"sm",title:"View Details",onClick:()=>I(s),children:e.jsx(ce,{size:16})}),e.jsx(g,{variant:"ghost",size:"sm",title:"Edit Customer",onClick:()=>m(s),children:e.jsx(me,{size:16})}),e.jsx(g,{variant:"ghost",size:"sm",title:"Delete Customer",onClick:()=>U(s),children:e.jsx(xe,{size:16,className:"text-destructive"})})]})]},s.id)})})]})}),P>0&&e.jsxs("div",{className:"flex justify-between items-center p-4 border-t",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Page ",o," of ",P," (",T," total)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{onClick:()=>t(s=>s-1),disabled:o===1,variant:"outline",size:"sm",children:[e.jsx(te,{size:16})," Prev"]}),e.jsxs(g,{onClick:()=>t(s=>s+1),disabled:o>=P,variant:"outline",size:"sm",children:["Next ",e.jsx(ae,{size:16})]})]})]}),D&&e.jsx(fe,{customerId:D.id,customerName:D.name,isOpen:!!D,onClose:()=>I(null)}),M&&e.jsx(ne,{isOpen:M,onClose:()=>A(!1),onConfirm:V,title:"Delete Customer",description:`Delete ${_==null?void 0:_.name}? This is irreversible.`,confirmText:"Delete"})]})},Me=()=>{const[i,m]=a.useState(null),[c,n]=a.useState(0),[d,p]=a.useState(!1),r=x=>{m(x),p(!1)},h=()=>{m(null),n(x=>x+1),p(!1)},f=()=>{m(null),p(!1)},N=()=>{m(null),p(!0)};return e.jsxs("div",{className:"p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:" Customers"}),e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm",children:"Manage your print shop customers"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:col-span-3 gap-6 items-start",children:[" ",e.jsx("div",{className:"lg:col-span-3",children:e.jsx(ye,{onEdit:r,onAdd:N,onDataChange:h},c)})]}),e.jsx(he,{isOpen:!!i||d,onClose:f,onSave:h,editingCustomer:i})]})};export{Me as default};
