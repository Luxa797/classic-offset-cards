import{ah as W,B as q,Z as P,r,E as e,J as U,a0 as C,a1 as _,T as M,Y as N,a2 as D,N as A,Q as T,W as I,ae as G,a9 as Q,ai as V,aj as J}from"./index-DM-CIWAp.js";import{d as b,r as Z}from"./relativeTime-B6BWBmOc.js";import{M as H}from"./Modal-vVolvInd.js";import{I as K}from"./Input-C5fRLLhS.js";import{B as L}from"./Button-CSkHMulG.js";import{P as X}from"./plus-circle-CW7gMPuW.js";import{S as ee}from"./send-BMFSPLCc.js";var $={exports:{}};(function(d,m){(function(h,n){d.exports=n()})(W,function(){return function(h,n,s){var l="h:mm A",o={lastDay:"[Yesterday at] "+l,sameDay:"[Today at] "+l,nextDay:"[Tomorrow at] "+l,nextWeek:"dddd [at] "+l,lastWeek:"[Last] dddd [at] "+l,sameElse:"MM/DD/YYYY"};n.prototype.calendar=function(u,c){var x=c||this.$locale().calendar||o,f=s(u||void 0).startOf("d"),i=this.diff(f,"d",!0),v="sameElse",w=i<-6?v:i<-1?"lastWeek":i<0?"lastDay":i<1?"sameDay":i<2?"nextDay":i<7?"nextWeek":v,j=x[w]||o[w];return typeof j=="function"?j.call(this,s()):this.format(j)}}})})($);var te=$.exports;const ae=q(te),se=({isOpen:d,onClose:m})=>{const{user:h,userProfile:n}=P(),[s,l]=r.useState(""),[o,u]=r.useState(!1),c=async x=>{if(x.preventDefault(),s.trim()===""||!n||!h){C.error("Topic cannot be empty and you must be logged in!");return}u(!0);try{await _(M(N,"chat_rooms"),{topic:s.trim(),createdBy:{id:h.id,name:n.name,role:n.role},createdAt:D(),lastMessage:`Chat room created by ${n.name}`,lastMessageAt:D()}),C.success("New chat room created!"),l(""),m()}catch(f){console.error("Error creating chat room: ",f),C.error(f.message||"Failed to create chat room.")}finally{u(!1)}};return e.jsx(H,{isOpen:d,onClose:m,title:"Start a New Chat Room",children:e.jsxs("form",{onSubmit:c,className:"space-y-4 pt-2",children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Create a new chat room to discuss a specific topic with your team."}),e.jsx(K,{id:"topic",label:"Chat Topic",value:s,onChange:x=>l(x.target.value),placeholder:"e.g., Q4 Marketing Plan, Urgent Delivery Updates",required:!0,disabled:o,autoFocus:!0}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(L,{type:"button",variant:"outline",onClick:m,disabled:o,children:"Cancel"}),e.jsx(L,{type:"submit",variant:"primary",disabled:o||!s.trim(),children:o?e.jsx(U,{className:"w-5 h-5 animate-spin"}):"Create Room"})]})]})})};b.extend(Z);b.extend(ae);const me=()=>{const{user:d,userProfile:m}=P(),[h,n]=r.useState([]),[s,l]=r.useState(null),[o,u]=r.useState({}),[c,x]=r.useState(""),[f,i]=r.useState(!1),[v,w]=r.useState(!0),[j,R]=r.useState(!1),E=r.useRef(null),B=()=>{var t;return(t=E.current)==null?void 0:t.scrollIntoView({behavior:"smooth"})};r.useEffect(B,[o]),r.useEffect(()=>{const t=A(M(N,"chat_rooms"),T("lastMessageAt","desc")),a=I(t,p=>{const y=[];p.forEach(k=>{y.push({id:k.id,...k.data()})}),n(y),w(!1)});return()=>a()},[]),r.useEffect(()=>{if(!s){u({});return}R(!0);const t=A(M(N,"team_chat_messages"),G("roomId","==",s),T("createdAt")),a=I(t,p=>{const k=p.docs.map(g=>({id:g.id,...g.data()})).reduce((g,Y)=>{var z;const S=b((z=Y.createdAt)==null?void 0:z.toDate()).format("YYYY-MM-DD");return g[S]||(g[S]=[]),g[S].push(Y),g},{});u(k),R(!1)});return()=>a()},[s]);const F=async t=>{if(t.preventDefault(),!(c.trim()===""||!s||!m||!d))try{await _(M(N,"team_chat_messages"),{roomId:s,text:c.trim(),createdAt:D(),userId:d.id,userName:m.name,userRole:m.role||"Member"});const a=V(N,"chat_rooms",s);await J(a,{lastMessage:c.trim(),lastMessageAt:D()}),x("")}catch(a){console.error("Error sending message: ",a)}},O=t=>b(t).calendar(null,{sameDay:"[Today]",lastDay:"[Yesterday]",lastWeek:"dddd, D MMM",sameElse:"dddd, D MMMM YYYY"});return e.jsxs(e.Fragment,{children:[e.jsx(se,{isOpen:f,onClose:()=>i(!1)}),e.jsxs("div",{className:"flex h-[calc(100vh-64px)] bg-gray-50 dark:bg-zinc-900 border-t",children:[e.jsxs("aside",{className:"w-1/3 min-w-[300px] max-w-[400px] flex flex-col border-r dark:border-zinc-700 bg-white dark:bg-zinc-800",children:[e.jsxs("div",{className:"p-4 border-b dark:border-zinc-700 flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Chat Rooms"}),e.jsx("button",{onClick:()=>i(!0),className:"p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-700",title:"Start new chat",children:e.jsx(X,{className:"w-6 h-6 text-primary-600"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:v?e.jsx("p",{className:"p-4 text-center",children:"Loading rooms..."}):h.map(t=>{var a;return e.jsxs("div",{onClick:()=>l(t.id),className:`p-4 border-b dark:border-zinc-700 cursor-pointer ${s===t.id?"bg-primary-50 dark:bg-primary-900/50":"hover:bg-gray-100 dark:hover:bg-zinc-700/50"}`,children:[e.jsx("h3",{className:"font-semibold text-gray-800 dark:text-white truncate",children:t.topic}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate",children:t.lastMessage}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:b((a=t.lastMessageAt)==null?void 0:a.toDate()).fromNow()})]},t.id)})})]}),e.jsx("main",{className:"flex-1 flex flex-col",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4",children:[j?e.jsx("p",{className:"text-center",children:"Loading messages..."}):Object.keys(o).sort().map(t=>e.jsxs("div",{children:[e.jsxs("div",{className:"relative my-5 text-center",children:[e.jsx("hr",{className:"absolute top-1/2 left-0 w-full border-t border-gray-200 dark:border-gray-700"}),e.jsx("span",{className:"relative inline-block px-3 bg-gray-50 dark:bg-zinc-900 text-sm font-medium text-gray-500 rounded-full",children:O(t)})]}),e.jsx("div",{className:"space-y-4",children:o[t].map(a=>{var y;const p=a.userId===(d==null?void 0:d.id);return e.jsx("div",{className:`flex items-end gap-2 ${p?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-md lg:max-w-lg p-3 rounded-2xl ${p?"bg-primary-600 text-white rounded-br-lg":"bg-white dark:bg-zinc-700 dark:text-gray-200 rounded-bl-lg"}`,children:[!p&&e.jsxs("p",{className:`text-xs font-bold mb-1 ${a.userRole==="Owner"?"text-red-400":a.userRole==="Manager"?"text-blue-400":"text-green-400"}`,children:[a.userName," (",a.userRole,")"]}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:a.text}),e.jsx("p",{className:"text-xs opacity-70 mt-1 text-right",children:b((y=a.createdAt)==null?void 0:y.toDate()).format("h:mm A")})]})},a.id)})})]},t)),e.jsx("div",{ref:E})]}),e.jsxs("footer",{className:"p-4 bg-white dark:bg-zinc-800 border-t dark:border-zinc-700",children:[e.jsxs("form",{onSubmit:F,className:"flex items-center gap-3",children:[e.jsx("input",{type:"text",value:c,onChange:t=>x(t.target.value),placeholder:"Type a message...",className:"flex-1 w-full px-4 py-2 bg-gray-100 dark:bg-zinc-700 border-transparent rounded-lg focus:ring-2 focus:ring-primary-500 focus:outline-none",autoFocus:!0}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 disabled:opacity-50",disabled:!c.trim(),children:e.jsx(ee,{className:"w-5 h-5"})})]}),e.jsxs("p",{className:"text-xs text-gray-400 mt-2 ml-1",children:["Press ",e.jsx("kbd",{className:"px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-md dark:bg-gray-900 dark:text-gray-100 dark:border-gray-900",children:"Enter"})," to send."]})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col justify-center items-center text-center p-4",children:[e.jsx(Q,{className:"w-16 h-16 text-gray-300 dark:text-zinc-600"}),e.jsx("h2",{className:"mt-4 text-xl font-semibold text-gray-700 dark:text-gray-300",children:"Select a room to start chatting"}),e.jsx("p",{className:"text-gray-500",children:"Choose from the list on the left or create a new chat room."})]})})]})]})};export{me as default};
