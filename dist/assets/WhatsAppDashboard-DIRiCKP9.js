import{r,ag as T,a3 as U,_ as g,a0 as v,E as t,J as R,I as G,a8 as W,a9 as H,Z as z}from"./index-BrZuWI6n.js";import{C as M}from"./Card-xKmTyOZv.js";import{B as K}from"./Button-Y7kV2YOr.js";import{S as $}from"./Select-DE_vlw4B.js";import{T as J}from"./TextArea-1DxkuCyq.js";import{S as V}from"./send-CqUFPTJk.js";const Z=({allCustomers:_,templates:f,onRefresh:N,initialOrder:l})=>{const{user:b}=z(),[d,C]=r.useState(""),[y,w]=r.useState(""),[s,j]=r.useState(null),[m,h]=r.useState(""),[x,S]=r.useState([]),[n,u]=r.useState(!1);r.useEffect(()=>{if(l){C(l.customer_id),S([l]),w(String(l.order_id));const e=f.find(o=>o.name.toLowerCase().includes("full invoice details"));e&&j(e)}},[l,f]),r.useEffect(()=>{d&&!l&&(async()=>{u(!0),S([]),w(""),j(null);const{data:o,error:p}=await g.from("all_order_summary").select("*").eq("customer_id",d).order("order_id",{ascending:!1});p?v.error("Failed to fetch orders for customer."):S(o),u(!1)})()},[d,l]),r.useEffect(()=>{let e=!0;return(async()=>{const p=_.find(c=>c.id===d),i=x.find(c=>c.order_id===parseInt(y));if(!s||!i||!p){e&&h("");return}u(!0);const{data:q,error:k}=await g.from("orders").select("quantity, order_type").eq("id",i.order_id).single(),{data:L,error:A}=await g.from("payments").select("payment_date, amount_paid, payment_method").eq("order_id",i.order_id).order("payment_date",{ascending:!0});if(!e)return;if(k||A){console.error("Order Details Error:",k),console.error("Payment History Error:",A),v.error("Failed to fetch full order details."),u(!1);return}const a={...i,...q};let O="இதுவரை பணம் எதுவும் செலுத்தப்படவில்லை";L&&L.length>0&&(O=L.map(c=>`- ₹${c.amount_paid.toLocaleString("en-IN")} via ${c.payment_method} on ${new Date(c.payment_date).toLocaleDateString("en-GB")}`).join(`
`));const B=`${window.location.origin}/invoices/${a.order_id}`,F={customer_name:a.customer_name,order_id:String(a.order_id),order_type:a.order_type,total_amount:a.total_amount.toLocaleString("en-IN"),balance_due:a.balance_due.toLocaleString("en-IN"),delivery_date:a.delivery_date?new Date(a.delivery_date).toLocaleDateString("en-GB"):"N/A",shop_name:"Classic Offset",status:a.status||"Processing",payment_amount:a.amount_paid.toLocaleString("en-IN"),pickup_date:a.delivery_date?new Date(a.delivery_date).toLocaleDateString("en-GB"):"N/A",quantity:String(a.quantity),amount_paid:a.amount_paid.toLocaleString("en-IN"),order_date:a.order_date?new Date(a.order_date).toLocaleDateString("en-GB"):"N/A",invoice_link:B,payment_history:O,customer_phone:a.customer_phone};let E=s.body;Object.entries(F).forEach(([c,P])=>{E=E.replace(new RegExp(`{{${c}}}`,"g"),String(P||""))}),e&&(h(E),u(!1))})(),()=>{e=!1}},[y,s,d,x,_]);const D=async()=>{const e=_.find(i=>i.id===d);if(!(e!=null&&e.phone)||!m)return v.error("Customer phone or message is missing.");const o=e.phone.replace(/\D/g,"");window.open(`https://wa.me/${o}?text=${encodeURIComponent(m)}`,"_blank","noopener,noreferrer");const{error:p}=await g.from("whatsapp_log").insert({customer_id:e.id,customer_name:e.name,phone:e.phone,message:m,template_name:s==null?void 0:s.name,sent_by:b==null?void 0:b.id});p?v.error(`Log failed: ${p.message}`):(v.success("Message sent and logged!"),N())},I=e=>`#${e.order_id} - ${e.order_type} (Due: ₹${e.balance_due.toLocaleString("en-IN")})`;return t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 items-start",children:[t.jsx(M,{title:"Compose Message",children:t.jsxs("div",{className:"p-5 space-y-4",children:[t.jsx($,{label:"1. Select Customer",options:_.map(e=>({value:e.id,label:`${e.name} (${e.phone})`})),value:d,onChange:e=>C(e.target.value),placeholder:"Choose a customer"}),t.jsx($,{label:"2. Select Order",options:x.map(e=>({value:e.order_id,label:I(e)})),value:y,onChange:e=>w(e.target.value),disabled:!d||n,placeholder:n?"Loading orders...":"Choose an order"}),t.jsx($,{label:"3. Select Template",options:f.map(e=>({value:e.name,label:e.name})),value:(s==null?void 0:s.name)||"",onChange:e=>j(f.find(o=>o.name===e.target.value)||null),disabled:!y,placeholder:"Choose a template"}),t.jsx(J,{label:"4. Review Message",value:m,onChange:e=>h(e.target.value),rows:12,placeholder:"Message will be generated here...",disabled:n}),t.jsxs(K,{onClick:D,fullWidth:!0,variant:"success",disabled:!m||n,children:[t.jsx(V,{className:"w-4 h-4 mr-2"})," Send on WhatsApp"]})]})}),t.jsx(M,{title:"Message Preview",children:t.jsx("div",{className:"p-5 min-h-[300px] bg-gray-50 dark:bg-gray-800 rounded-b-lg",children:n?t.jsx("div",{className:"flex justify-center items-center h-full",children:t.jsx(R,{className:"animate-spin"})}):t.jsx("pre",{className:"text-sm text-gray-700 dark:text-gray-200 whitespace-pre-wrap font-sans",children:m||"Select customer, order, and template for preview."})})})]})},re=()=>{const[_,f]=r.useState(!0),[N,l]=r.useState(null),[b,d]=r.useState([]),[C,y]=r.useState([]),[w,s]=r.useState(null),[j,m]=r.useState(0),h=T(),x=U(),S=r.useCallback(async()=>{f(!0),l(null);try{const u=new URLSearchParams(h.search).get("orderId"),[D,I,e]=await Promise.all([g.from("customers").select("id, name, phone").order("name"),g.from("whatsapp_templates").select("*").order("name"),g.from("all_order_summary").select("*").gt("balance_due",0)]),o=[D.error,I.error,e.error].filter(Boolean);if(o.length>0)throw o[0];if(d(D.data||[]),y(I.data||[]),u){const{data:p,error:i}=await g.from("all_order_summary").select("*").eq("order_id",u).single();if(i)throw i;s(p),x(h.pathname,{replace:!0})}else s(null)}catch(n){v.error(n.message||"Failed to load dashboard data."),l(n.message)}finally{f(!1)}},[h.search,x]);return r.useEffect(()=>{S()},[S,j]),_?t.jsx("div",{className:"text-center p-8",children:t.jsx(R,{className:"w-8 h-8 animate-spin mx-auto text-primary-500"})}):N?t.jsx(M,{className:"m-4",children:t.jsxs("div",{className:"p-4 bg-red-50 text-red-700 rounded-md",children:[t.jsx(G,{className:"inline w-5 mr-2"})," ",N]})}):t.jsxs("div",{className:"p-4 sm:p-6 space-y-6",children:[t.jsx(W,{position:"top-right"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(H,{size:28,className:"text-green-500"}),t.jsxs("div",{children:[t.jsx("h1",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:"WhatsApp Suite"}),t.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Send personalized messages to your customers."})]})]}),t.jsx(Z,{allCustomers:b,templates:C,initialOrder:w,onRefresh:()=>m(n=>n+1)})]})};export{re as default};
