import{r as t,_ as w,E as e,J as k,a7 as A,Z as L}from"./index-BrZuWI6n.js";import{I as _}from"./Input-D3jXC-x9.js";import{B as N}from"./Button-Y7kV2YOr.js";import{S as P,T as q,a as F,P as D}from"./toggle-right-vJkxmOGn.js";import{S as z}from"./search-B3PwDds0.js";import{T as R}from"./trash-2-Cbos4vZN.js";import{M as T}from"./Modal-BMGMe01h.js";import{S as B}from"./Select-DE_vlw4B.js";import{C as I}from"./Card-xKmTyOZv.js";import{U as K}from"./user-plus-B0h9sTww.js";const Y=({onEditUser:g,onDataChange:x,currentUserRole:j,currentUserId:a})=>{const[d,c]=t.useState([]),[p,l]=t.useState(!0),[u,f]=t.useState(null),[n,v]=t.useState(""),[y,h]=t.useState("created_at"),[b,U]=t.useState("desc"),S=t.useCallback(async()=>{l(!0),f(null);try{const[s,r]=await Promise.all([w.from("users").select("*").order(y,{ascending:b==="asc"}),w.from("user_status").select("user_id, status")]);if(s.error)throw s.error;if(r.error)throw r.error;const m=(r.data||[]).reduce((E,O)=>(E[O.user_id]={status:O.status},E),{}),C=(s.data||[]).map(E=>({...E,user_status:m[E.id]}));c(C)}catch(s){f(s.message)}finally{l(!1)}},[y,b]);t.useEffect(()=>{S()},[S,x]);const M=async s=>{if(j!=="Owner")return alert("Permission Denied.");if(s.id===a)return alert("You cannot delete your own account.");if(!confirm(`Are you sure you want to delete ${s.name}?`))return;l(!0);const{error:r}=await w.from("users").delete().eq("id",s.id);l(!1),r?alert("Error deleting user: "+r.message):(alert("User deleted successfully."),x())},o=async s=>{var C;if(j!=="Owner")return alert("Permission Denied.");if(s.id===a)return alert("You cannot change your own status.");const r=((C=s.user_status)==null?void 0:C.status)==="active"?"inactive":"active";l(!0);const{error:m}=await w.from("user_status").upsert({user_id:s.id,status:r},{onConflict:"user_id"});l(!1),m?alert("Error updating status: "+m.message):(alert("Status updated successfully."),x())},i=t.useMemo(()=>n?d.filter(s=>{var r,m;return((r=s.name)==null?void 0:r.toLowerCase().includes(n.toLowerCase()))||((m=s.email)==null?void 0:m.toLowerCase().includes(n.toLowerCase()))}):d,[d,n]);return p?e.jsxs("div",{children:[e.jsx(k,{className:"animate-spin"})," Loading users..."]}):u?e.jsxs("div",{className:"p-4 text-red-600 bg-red-50 rounded-md",children:[e.jsx(P,{className:"inline-block mr-2"})," ",u]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4",children:e.jsx(_,{id:"search",placeholder:"Search users by name or email...",value:n,onChange:s=>v(s.target.value),icon:e.jsx(z,{size:16})})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Email"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Role"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Status"}),j==="Owner"&&e.jsx("th",{scope:"col",className:"px-4 py-3 text-left text-xs font-medium uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700",children:i.map(s=>{var r,m;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:s.name}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:s.email}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:s.role}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:((r=s.user_status)==null?void 0:r.status)||"N/A"}),j==="Owner"&&e.jsxs("td",{className:"px-4 py-3 whitespace-nowrap text-right text-sm font-medium space-x-2",children:[e.jsx(N,{variant:"icon",onClick:()=>o(s),title:"Toggle Status",children:((m=s.user_status)==null?void 0:m.status)==="active"?e.jsx(q,{className:"text-green-500"}):e.jsx(F,{className:"text-red-500"})}),e.jsx(N,{variant:"icon",onClick:()=>g(s),title:"Edit User",children:e.jsx(D,{size:16})}),e.jsx(N,{variant:"icon",onClick:()=>M(s),title:"Delete User",children:e.jsx(R,{size:16,className:"text-red-600"})})]})]},s.id)})})]})})]})},J=({isOpen:g,onClose:x,onSave:j,editingUser:a,currentUserRole:d})=>{const[c,p]=t.useState(""),[l,u]=t.useState(""),[f,n]=t.useState("Staff"),[v,y]=t.useState(""),[h,b]=t.useState(!1),[U,S]=t.useState(null);t.useEffect(()=>{a?(p(a.name||""),u(a.email||""),n(a.role||"Staff"),y("")):(p(""),u(""),n("Staff"),y("")),S(null)},[a,g]);const M=async o=>{o.preventDefault(),b(!0),S(null);try{if(a){const{data:i,error:s}=await w.from("users").update({name:c,...d==="Owner"&&{role:f}}).eq("id",a.id).select().single();if(s)throw s;alert("âœ… User updated successfully")}else{if(!v)throw new Error("Password is required for new users.");const{data:i,error:s}=await w.auth.signUp({email:l,password:v,options:{data:{full_name:c,user_role:f}}});if(s)throw s;if(!i.user)throw new Error("Could not create authentication user.");console.log("Auth user created:",i.user);const{error:r}=await w.from("users").insert([{id:i.user.id,name:c,email:l,role:f}]);if(r)throw await w.auth.admin.deleteUser(i.user.id),r;await w.from("user_status").insert([{user_id:i.user.id,status:"active"}]),alert("âœ… User created successfully! They can now log in.")}j(),x()}catch(i){S(i.message||"An unexpected error occurred."),console.error(i)}finally{b(!1)}};return g?e.jsx(T,{onClose:x,title:a?"Edit User":"Add New User",isOpen:g,children:e.jsxs("form",{onSubmit:M,className:"space-y-4 pt-2",children:[U&&e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 text-red-700 border border-red-200 rounded-md text-sm",children:[e.jsx(A,{size:18}),e.jsx("span",{children:U})]}),e.jsx(_,{id:"name",label:"Full Name",value:c,onChange:o=>p(o.target.value),required:!0}),e.jsx(_,{id:"email",label:"Email Address",type:"email",value:l,onChange:o=>u(o.target.value),required:!0,disabled:!!a}),!a&&e.jsx(_,{id:"password",label:"Password",type:"password",value:v,onChange:o=>y(o.target.value),placeholder:"Enter a strong password",required:!0}),e.jsx(B,{id:"role",label:"User Role",value:f,onChange:o=>n(o.target.value),options:[{value:"Staff",label:"Staff"},{value:"Manager",label:"Manager"},...d==="Owner"?[{value:"Owner",label:"Owner"}]:[]],required:!0,disabled:d!=="Owner"}),e.jsxs("div",{className:"flex justify-end gap-3 pt-5",children:[e.jsx(N,{type:"button",variant:"outline",onClick:x,disabled:h,children:"Cancel"}),e.jsx(N,{type:"submit",loading:h,variant:"primary",disabled:h,children:h?e.jsx(k,{className:"animate-spin"}):a?"Save Changes":"Create User"})]})]})}):null},te=()=>{const[g,x]=t.useState(0),[j,a]=t.useState(null),[d,c]=t.useState(!1),{user:p,userProfile:l}=L(),u=l==null?void 0:l.role,f=p==null?void 0:p.id,n=()=>{x(h=>h+1)},v=()=>{a(null),c(!0)},y=h=>{a(h),c(!0)};return e.jsxs("div",{className:"p-4 sm:p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-center gap-4",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-800 dark:text-white",children:"ðŸ‘¥ User Management"}),u==="Owner"&&e.jsxs(N,{onClick:v,variant:"primary",className:"flex items-center w-full sm:w-auto",children:[e.jsx(K,{className:"w-5 h-5 mr-2"}),"Add New User"]})]}),e.jsx(I,{children:e.jsx(Y,{onEditUser:y,currentUserRole:u,currentUserId:f,onDataChange:n},g)}),d&&e.jsx(J,{isOpen:d,onClose:()=>c(!1),onSave:n,editingUser:j,currentUserRole:u})]})};export{te as default};
