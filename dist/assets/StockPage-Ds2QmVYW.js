import{r as n,E as e,_ as L,Z as de,J as W,N as me,T as Y,Y as Z,ae as J,af as ue,a1 as xe,a2 as ge,a0 as he,I as X,P as K,aa as pe}from"./index-DM-CIWAp.js";import{I as $}from"./Input-C5fRLLhS.js";import{B as U}from"./Button-CSkHMulG.js";import{C as I}from"./Card-Cs5NGpgY.js";import{T as ye}from"./TextArea-JRPRJW7n.js";import{l as _e}from"./activityLogger-D_imCEB0.js";import{S as P}from"./Select-BRlx7a9F.js";import{H as fe}from"./history-CnJ7OVOR.js";import{R as ee}from"./refresh-cw-DxPtey9L.js";import{D as te}from"./download-DMkQx4BI.js";import{S as se}from"./search-CuRiBKad.js";import{F as je}from"./filter-fEcCECdL.js";import{C as ae}from"./calendar-BnS4Q6u9.js";import{S as re}from"./shopping-cart-CWveINg6.js";import{R as Ne,T as le}from"./trending-up-hsClnWHh.js";import{T as ne}from"./trending-down-iJBy7Jwg.js";import{M as be}from"./Modal-vVolvInd.js";import{P as ve}from"./printer-Db08zeDp.js";import{M as ke}from"./map-pin-BEsdh5VF.js";import{S as Se}from"./square-pen-Ctp6C1gD.js";import{E as we}from"./eye-DucQexOi.js";import{H as Ce}from"./hash-DO09y1h8.js";const Te=()=>{const[x,A]=n.useState({item_name:"",category:"",quantity_in:"",quantity_used:""}),[V,w]=n.useState(!1),[q,O]=n.useState(""),l=b=>{const{name:f,value:j}=b.target;A(E=>({...E,[f]:j}))},k=async b=>{b.preventDefault(),w(!0),O("");const{item_name:f,category:j,quantity_in:E,quantity_used:M}=x,{error:D}=await L.from("stock").insert([{item_name:f,category:j,quantity_in:Number(E),quantity_used:Number(M||0)}]);D?O("âŒ Failed to add stock: "+D.message):(O("âœ… Stock added successfully!"),A({item_name:"",category:"",quantity_in:"",quantity_used:""})),w(!1)};return e.jsx(I,{title:" Add New Stock Item",children:e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsx($,{label:"Item Name",name:"item_name",value:x.item_name,onChange:l,required:!0}),e.jsx($,{label:"Category",name:"category",value:x.category,onChange:l}),e.jsx($,{label:"Quantity In",name:"quantity_in",type:"number",value:x.quantity_in,onChange:l,required:!0}),e.jsx($,{label:"Quantity Used",name:"quantity_used",type:"number",value:x.quantity_used,onChange:l}),e.jsx(U,{type:"submit",disabled:V,children:V?"Saving...":"Save Stock"}),q&&e.jsx("p",{className:"text-sm text-center",children:q})]})})},Ue=()=>{const{userProfile:x}=de(),[A,V]=n.useState([]),[w]=n.useState("all"),[q,O]=n.useState(""),[l,k]=n.useState(""),[b,f]=n.useState(""),[j,E]=n.useState(""),[M,D]=n.useState(!1),[F,t]=n.useState(!0),[S,p]=n.useState(""),c=async()=>{t(!0);try{const s=[];(w==="all"||w==="existing_stock")&&s.push(L.from("stock").select("id, item_name, quantity_in, quantity_used, category, minimum_stock_level").then(({data:u,error:C})=>{if(C)throw C;return(u||[]).map(g=>({id:`existing_${g.id}`,item_name:`${g.item_name} (Existing Stock)`,balance:(g.quantity_in||0)-(g.quantity_used||0),unit_of_measurement:"pieces",minimum_stock_level:g.minimum_stock_level||0,source:"existing_stock",category:g.category,storage_location:"Existing Stock"}))})),(w==="all"||w==="materials")&&s.push(L.from("materials_with_details").select("id, material_name, current_quantity, unit_of_measurement, category_name, supplier_name, storage_location, minimum_stock_level").then(({data:u,error:C})=>{if(C)throw C;return(u||[]).map(g=>({id:`material_${g.id}`,item_name:`${g.material_name} (Materials)`,balance:g.current_quantity||0,unit_of_measurement:g.unit_of_measurement||"pieces",minimum_stock_level:g.minimum_stock_level||0,source:"materials",category:g.category_name,supplier_name:g.supplier_name,storage_location:g.storage_location}))}));const h=(await Promise.all(s)).flat().filter(u=>u.balance>0);h.sort((u,C)=>u.item_name.localeCompare(C.item_name)),V(h)}catch(s){console.error("Error fetching stock list:",s),p("âŒ Failed to load stock items. Please try again.")}finally{t(!1)}};n.useEffect(()=>{c()},[w]);const N=async s=>{s.preventDefault(),D(!0),p("");const d=A.find(u=>u.id===q);if(!d){p("âŒ Please select a valid stock item."),D(!1);return}const h=Number(l);if(h<=0||isNaN(h)){p("âŒ Quantity must be a positive number."),D(!1);return}if(h>d.balance){p("âŒ Cannot use more than available balance."),D(!1);return}try{const u=(x==null?void 0:x.name)||"Admin";if(d.source==="existing_stock"){const T=d.id.replace("existing_","");await L.from("stock_usage_log").insert([{stock_id:parseInt(T),used_quantity:h,used_for:b,notes:j||null}]),await L.rpc("increment_quantity_used",{stock_id_input:parseInt(T),additional_used:h})}else{const T=d.id.replace("material_","");await L.from("material_transactions").insert([{material_id:T,transaction_type:"OUT",quantity:h,notes:`Used for: ${b}${j?` | Notes: ${j}`:""}`}])}const C=`Used ${h} ${d.unit_of_measurement} of "${d.item_name}" for ${b}.`;await _e(C,u);const g=d.balance-h;if(g<=d.minimum_stock_level){const T=new Date;T.setDate(T.getDate()-1);const z=me(Y(Z,"notifications"),J("type","==","low_stock"),J("relatedId","==",d.id),J("timestamp",">",T));if((await ue(z)).empty){const B=`Stock for "${d.item_name}" is low (${g} ${d.unit_of_measurement} remaining).`;await xe(Y(Z,"notifications"),{message:B,type:"low_stock",relatedId:d.id,timestamp:ge(),read:!1,triggeredBy:"System"}),he(B,{icon:"âš ï¸"})}}p("âœ… Stock usage recorded successfully!"),O(""),k(""),f(""),E(""),c(),setTimeout(()=>p(""),3e3)}catch(u){console.error("Error recording stock usage:",u),p(`âŒ Failed to record usage: ${u.message}`)}finally{D(!1)}},m=A.find(s=>s.id===q);return e.jsx(I,{children:e.jsxs("div",{className:"p-5",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 dark:text-white mb-4",children:"Record Stock Usage"}),e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Stock Source"}),e.jsx("div",{className:"grid grid-cols-3 gap-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1",children:"Select Item *"}),F?e.jsxs("div",{className:"flex items-center justify-center py-3 border rounded-lg",children:[e.jsx(W,{className:"w-4 h-4 animate-spin mr-2"}),e.jsx("span",{children:"Loading..."})]}):e.jsxs("select",{value:q,onChange:s=>O(s.target.value),className:"w-full px-3 py-2 border rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"-- Select Item --"}),A.map(s=>e.jsxs("option",{value:s.id,children:[s.item_name," | Available: ",s.balance," ",s.unit_of_measurement]},s.id))]})]}),m&&e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg"}),e.jsx($,{label:"Quantity Used *",name:"used_quantity",type:"number",step:"0.01",min:"0.01",value:l,onChange:s=>k(s.target.value),required:!0}),e.jsx($,{label:"Used For *",name:"used_for",placeholder:"e.g., Order #123",value:b,onChange:s=>f(s.target.value),required:!0}),e.jsx(ye,{id:"notes",label:"Additional Notes",value:j,onChange:s=>E(s.target.value)}),e.jsx(U,{type:"submit",disabled:M||F||!q,className:"w-full",children:M?"Recording...":"Record Stock Usage"}),S&&e.jsx("div",{className:`mt-4 p-3 rounded-lg text-sm ${S.includes("âœ…")?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:S})]})]})})},qe=()=>{const[x,A]=n.useState([]),[V,w]=n.useState(!0),[q,O]=n.useState([]),[l,k]=n.useState({source:"",transactionType:"",category:"",startDate:"",endDate:"",search:""}),b=async()=>{w(!0);try{const t=[];t.push(L.from("stock_usage_log").select(`
            id, used_quantity, used_for, used_at,
            stock:stock_id (
              item_name, category
            )
          `).order("used_at",{ascending:!1}).then(({data:N,error:m})=>{if(m)throw m;return(N||[]).map(s=>{var d,h;return{id:`usage_${s.id}`,item_name:((d=s.stock)==null?void 0:d.item_name)||"Unknown Item",transaction_type:"USAGE",quantity:s.used_quantity,unit_of_measurement:"pieces",used_for:s.used_for,notes:void 0,transaction_date:s.used_at,source:"existing_stock",category:(h=s.stock)==null?void 0:h.category}})})),t.push(L.from("material_transactions").select(`
            id, transaction_type, quantity, unit_cost, total_cost, 
            reference_number, notes, transaction_date,
            materials:material_id (
              material_name, unit_of_measurement, category:material_categories(name),
              supplier:suppliers(name)
            )
          `).order("transaction_date",{ascending:!1}).then(({data:N,error:m})=>{if(m)throw m;return(N||[]).map(s=>{var d,h,u,C,g,T;return{id:`material_${s.id}`,item_name:((d=s.materials)==null?void 0:d.material_name)||"Unknown Material",transaction_type:s.transaction_type,quantity:s.quantity,unit_of_measurement:((h=s.materials)==null?void 0:h.unit_of_measurement)||"pieces",notes:s.notes,transaction_date:s.transaction_date,source:"materials",category:(C=(u=s.materials)==null?void 0:u.category)==null?void 0:C.name,supplier_name:(T=(g=s.materials)==null?void 0:g.supplier)==null?void 0:T.name,reference_number:s.reference_number,cost_per_unit:s.unit_cost,total_cost:s.total_cost}})}));const p=(await Promise.all(t)).flat();p.sort((N,m)=>new Date(m.transaction_date).getTime()-new Date(N.transaction_date).getTime()),A(p);const c=[...new Set(p.map(N=>N.category).filter(Boolean))];O(c)}catch(t){console.error("Error fetching transaction history:",t)}finally{w(!1)}};n.useEffect(()=>{b()},[]);const f=n.useMemo(()=>x.filter(t=>{var s,d;const S=!l.source||t.source===l.source,p=!l.transactionType||t.transaction_type===l.transactionType,c=!l.category||t.category===l.category,N=!l.search||t.item_name.toLowerCase().includes(l.search.toLowerCase())||((s=t.used_for)==null?void 0:s.toLowerCase().includes(l.search.toLowerCase()))||((d=t.notes)==null?void 0:d.toLowerCase().includes(l.search.toLowerCase()));let m=!0;if(l.startDate||l.endDate){const h=new Date(t.transaction_date);if(l.startDate&&(m=m&&h>=new Date(l.startDate)),l.endDate){const u=new Date(l.endDate);u.setHours(23,59,59,999),m=m&&h<=u}}return S&&p&&c&&N&&m}),[x,l]),j=n.useMemo(()=>{const t=f.length,S=f.filter(m=>m.transaction_type==="IN").length,p=f.filter(m=>["OUT","USAGE"].includes(m.transaction_type)).length,c=f.filter(m=>m.transaction_type==="ADJUSTMENT").length,N=f.reduce((m,s)=>m+(s.total_cost||0),0);return{totalTransactions:t,inTransactions:S,outTransactions:p,adjustments:c,totalValue:N}},[f]),E=t=>{switch(t){case"IN":return e.jsx(le,{className:"w-4 h-4 text-green-500"});case"OUT":case"USAGE":return e.jsx(ne,{className:"w-4 h-4 text-red-500"});case"ADJUSTMENT":return e.jsx(Ne,{className:"w-4 h-4 text-blue-500"});default:return e.jsx(K,{className:"w-4 h-4 text-gray-500"})}},M=t=>{switch(t){case"IN":return"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300";case"OUT":case"USAGE":return"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300";case"ADJUSTMENT":return"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300";default:return"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"}},D=()=>{const t=["Date","Item Name","Source","Type","Quantity","Unit","Category","Used For","Reference","Cost","Notes"],S=f.map(s=>[new Date(s.transaction_date).toLocaleDateString(),s.item_name,s.source==="existing_stock"?"Existing Stock":"Materials",s.transaction_type,s.quantity,s.unit_of_measurement,s.category||"-",s.used_for||"-",s.reference_number||"-",s.total_cost?`â‚¹${s.total_cost}`:"-",s.notes||"-"]),p=[t,...S].map(s=>s.map(d=>`"${d}"`).join(",")).join(`
`),c=new Blob([p],{type:"text/csv"}),N=window.URL.createObjectURL(c),m=document.createElement("a");m.href=N,m.download=`stock-transaction-history-${new Date().toISOString().split("T")[0]}.csv`,m.click(),window.URL.revokeObjectURL(N)},F=()=>{k({source:"",transactionType:"",category:"",startDate:"",endDate:"",search:""})};return V?e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(W,{className:"w-8 h-8 animate-spin text-primary-500"}),e.jsx("span",{className:"ml-2",children:"Loading transaction history..."})]})}):e.jsx(I,{children:e.jsxs("div",{className:"p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"w-5 h-5 text-primary-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800 dark:text-white",children:"ğŸ“… Comprehensive Stock History"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(U,{onClick:b,variant:"outline",size:"sm",children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),"Refresh"]}),e.jsxs(U,{onClick:D,variant:"outline",size:"sm",children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"Export CSV"]})]})]}),e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-6",children:"Complete transaction history from both existing stock and materials inventory"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4 mb-6",children:[e.jsxs("div",{className:"p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg",children:[e.jsx("div",{className:"text-xs text-blue-600 dark:text-blue-400",children:"Total Transactions"}),e.jsx("div",{className:"text-lg font-bold text-blue-800 dark:text-blue-200",children:j.totalTransactions})]}),e.jsxs("div",{className:"p-3 bg-green-50 dark:bg-green-900/30 rounded-lg",children:[e.jsx("div",{className:"text-xs text-green-600 dark:text-green-400",children:"Stock In"}),e.jsx("div",{className:"text-lg font-bold text-green-800 dark:text-green-200",children:j.inTransactions})]}),e.jsxs("div",{className:"p-3 bg-red-50 dark:bg-red-900/30 rounded-lg",children:[e.jsx("div",{className:"text-xs text-red-600 dark:text-red-400",children:"Stock Out/Used"}),e.jsx("div",{className:"text-lg font-bold text-red-800 dark:text-red-200",children:j.outTransactions})]}),e.jsxs("div",{className:"p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg",children:[e.jsx("div",{className:"text-xs text-purple-600 dark:text-purple-400",children:"Adjustments"}),e.jsx("div",{className:"text-lg font-bold text-purple-800 dark:text-purple-200",children:j.adjustments})]}),e.jsxs("div",{className:"p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg",children:[e.jsx("div",{className:"text-xs text-yellow-600 dark:text-yellow-400",children:"Total Value"}),e.jsxs("div",{className:"text-lg font-bold text-yellow-800 dark:text-yellow-200",children:["â‚¹",j.totalValue.toLocaleString()]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg",children:[e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"w-4 h-4 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"}),e.jsx($,{id:"search-history",placeholder:"Search transactions...",value:l.search,onChange:t=>k({...l,search:t.target.value}),className:"pl-10"})]}),e.jsx(P,{id:"source-filter",label:"",options:[{value:"existing_stock",label:"Existing Stock"},{value:"materials",label:"Materials"}],value:l.source,onChange:t=>k({...l,source:t.target.value}),placeholder:"All Sources"}),e.jsx(P,{id:"type-filter",label:"",options:[{value:"IN",label:"Stock In"},{value:"OUT",label:"Stock Out"},{value:"USAGE",label:"Usage"},{value:"ADJUSTMENT",label:"Adjustment"}],value:l.transactionType,onChange:t=>k({...l,transactionType:t.target.value}),placeholder:"All Types"}),e.jsx(P,{id:"category-filter",label:"",options:q.map(t=>({value:t,label:t})),value:l.category,onChange:t=>k({...l,category:t.target.value}),placeholder:"All Categories"}),e.jsx($,{id:"start-date",type:"date",value:l.startDate,onChange:t=>k({...l,startDate:t.target.value}),placeholder:"Start Date"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx($,{id:"end-date",type:"date",value:l.endDate,onChange:t=>k({...l,endDate:t.target.value}),placeholder:"End Date",className:"flex-1"}),e.jsx(U,{onClick:F,variant:"outline",size:"sm",children:e.jsx(je,{className:"w-4 h-4"})})]})]}),f.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(X,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"font-medium",children:"No transactions found"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your filters or check back later."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Date & Time"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Item"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Source"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Type"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium",children:"Quantity"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Used For / Reference"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium",children:"Value"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Notes"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:f.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-3 h-3 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:new Date(t.transaction_date).toLocaleDateString()}),e.jsx("div",{className:"text-xs text-gray-500",children:new Date(t.transaction_date).toLocaleTimeString()})]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:t.item_name}),e.jsxs("div",{className:"text-xs text-gray-500",children:[t.category&&`${t.category} â€¢ `,t.unit_of_measurement,t.supplier_name&&` â€¢ ${t.supplier_name}`]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${t.source==="existing_stock"?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300":"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300"}`,children:t.source==="existing_stock"?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-3 h-3 inline mr-1"}),"Existing"]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"w-3 h-3 inline mr-1"}),"Materials"]})})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("span",{className:`px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1 w-fit ${M(t.transaction_type)}`,children:[E(t.transaction_type),t.transaction_type]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsxs("span",{className:`font-medium ${["OUT","USAGE"].includes(t.transaction_type)?"text-red-600":t.transaction_type==="IN"?"text-green-600":"text-blue-600"}`,children:[["OUT","USAGE"].includes(t.transaction_type)?"-":"+",t.quantity]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"max-w-xs",children:[t.used_for&&e.jsx("div",{className:"text-gray-900 dark:text-white text-sm",children:t.used_for}),t.reference_number&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Ref: ",t.reference_number]}),!t.used_for&&!t.reference_number&&e.jsx("span",{className:"text-gray-400",children:"-"})]})}),e.jsx("td",{className:"px-4 py-3 text-right",children:t.total_cost?e.jsxs("span",{className:"font-medium text-green-600",children:["â‚¹",t.total_cost.toLocaleString()]}):e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"max-w-xs",children:t.notes?e.jsx("span",{className:"text-gray-600 dark:text-gray-300 text-sm\\",title:t.notes,children:t.notes.length>50?`${t.notes.substring(0,50)}...`:t.notes}):e.jsx("span",{className:"text-gray-400",children:"-"})})})]},t.id))})]})})]})})},De=()=>{const[x,A]=n.useState([]),[V,w]=n.useState(!0),[q,O]=n.useState(""),[l,k]=n.useState(""),[b,f]=n.useState(""),[j,E]=n.useState(""),[M,D]=n.useState(""),[F,t]=n.useState("item_name"),[S,p]=n.useState("asc"),[c,N]=n.useState(null),[m,s]=n.useState(!1),[d,h]=n.useState(""),[u,C]=n.useState("add"),g=async()=>{w(!0);try{const{data:a,error:o}=await L.from("stock").select("*").order("item_name");if(o)throw o;const{data:i,error:_}=await L.from("materials_with_details").select("*").order("material_name");if(_)throw _;const v=(a||[]).map(r=>({id:`existing_${r.id}`,item_name:r.item_name,category:r.category||"Uncategorized",current_quantity:r.quantity_in||0,quantity_used:r.quantity_used||0,balance:(r.quantity_in||0)-(r.quantity_used||0),storage_location:r.storage_location||"Not specified",minimum_threshold:100,last_updated:r.updated_at||r.created_at,unit_of_measurement:"pieces",cost_per_unit:0,source:"existing_stock",stock_status:(r.quantity_in||0)-(r.quantity_used||0)<=0?"OUT_OF_STOCK":(r.quantity_in||0)-(r.quantity_used||0)<=100?"LOW_STOCK":"IN_STOCK",total_value:((r.quantity_in||0)-(r.quantity_used||0))*10})),R=(i||[]).map(r=>({id:`material_${r.id}`,item_name:r.material_name,category:r.category_name||"Uncategorized",current_quantity:r.current_quantity||0,balance:r.current_quantity||0,storage_location:r.storage_location||"Not specified",minimum_threshold:r.minimum_stock_level||0,last_updated:r.updated_at||r.created_at,unit_of_measurement:r.unit_of_measurement||"pieces",cost_per_unit:r.cost_per_unit||0,source:"materials",supplier_name:r.supplier_name,stock_status:r.stock_status,total_value:r.total_value||0})),y=[...v,...R];A(y)}catch(a){console.error("Error fetching stock data:",a)}finally{w(!1)}};n.useEffect(()=>{g()},[]);const T=n.useMemo(()=>{const a=[...new Set(x.map(i=>i.category))].filter(Boolean),o=[...new Set(x.map(i=>i.storage_location))].filter(Boolean);return{categories:a.map(i=>({value:i,label:i})),locations:o.map(i=>({value:i,label:i}))}},[x]),z=n.useMemo(()=>{let a=x.filter(o=>{const i=o.item_name.toLowerCase().includes(q.toLowerCase()),_=!l||o.category===l,v=!j||o.storage_location===j,R=!M||o.source===M;let y=!0;return b==="low_stock"?y=o.stock_status==="LOW_STOCK":b==="out_of_stock"?y=o.stock_status==="OUT_OF_STOCK":b==="in_stock"&&(y=o.stock_status==="IN_STOCK"),i&&_&&v&&R&&y});return a.sort((o,i)=>{let _=o[F],v=i[F];return typeof _=="string"&&(_=_.toLowerCase(),v=v.toLowerCase()),S==="asc"?_>v?1:-1:_<v?1:-1}),a},[x,q,l,b,j,M,F,S]),Q=n.useMemo(()=>{const a=x.length,o=x.filter(r=>r.source==="existing_stock").length,i=x.filter(r=>r.source==="materials").length,_=x.filter(r=>r.stock_status==="LOW_STOCK").length,v=x.filter(r=>r.stock_status==="OUT_OF_STOCK").length,R=x.reduce((r,H)=>r+H.total_value,0),y=x.filter(r=>{const H=new Date(r.last_updated),G=new Date;return G.setDate(G.getDate()-7),H>G}).length;return{totalItems:a,totalValue:R,lowStockItems:_,outOfStockItems:v,recentMovements:y,existingStockItems:o,materialsItems:i}},[x]),B=a=>{switch(a){case"OUT_OF_STOCK":return{color:"text-red-600",bgColor:"bg-red-100 dark:bg-red-900/30"};case"LOW_STOCK":return{color:"text-yellow-600",bgColor:"bg-yellow-100 dark:bg-yellow-900/30"};case"IN_STOCK":return{color:"text-green-600",bgColor:"bg-green-100 dark:bg-green-900/30"};default:return{color:"text-gray-600",bgColor:"bg-gray-100 dark:bg-gray-700"}}},ie=a=>{if(a.source==="existing_stock"){const o=a.current_quantity||1;return Math.min(a.balance/o*100,100)}else{const o=a.minimum_threshold||1;return Math.min(a.balance/(o*2)*100,100)}},ce=async()=>{if(!c||!d)return;const a=parseInt(d);try{if(c.source==="existing_stock"){const o=c.id.replace("existing_","");let i=c.quantity_used||0;u==="add"?i=Math.max(0,i-a):u==="subtract"?i=i+a:u==="set"&&(i=c.current_quantity-a);const{error:_}=await L.from("stock").update({quantity_used:i}).eq("id",o);if(_)throw _}else{const o=c.id.replace("material_","");let i="ADJUSTMENT",_=a;u==="add"?i="IN":u==="subtract"?i="OUT":u==="set"&&(i="ADJUSTMENT",_=a);const{error:v}=await L.from("material_transactions").insert({material_id:o,transaction_type:i,quantity:_,notes:`Stock update via comprehensive view - ${u}`});if(v)throw v}await g(),s(!1),h(""),N(null)}catch(o){console.error("Error updating quantity:",o),alert("Failed to update quantity")}},oe=()=>{const a=["Item Name","Category","Current Stock","Unit","Status","Location","Source","Supplier","Value","Last Updated"],o=z.map(y=>[y.item_name,y.category,y.balance,y.unit_of_measurement,y.stock_status.replace("_"," "),y.storage_location,y.source==="existing_stock"?"Existing Stock":"Materials",y.supplier_name||"-",`â‚¹${y.total_value.toLocaleString()}`,new Date(y.last_updated).toLocaleDateString()]),i=[a,...o].map(y=>y.map(r=>`"${r}"`).join(",")).join(`
`),_=new Blob([i],{type:"text/csv"}),v=window.URL.createObjectURL(_),R=document.createElement("a");R.href=v,R.download=`unified-stock-inventory-${new Date().toISOString().split("T")[0]}.csv`,R.click(),window.URL.revokeObjectURL(v)};return V?e.jsx(I,{children:e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(W,{className:"w-8 h-8 animate-spin text-primary-500"}),e.jsx("span",{className:"ml-2",children:"Loading unified stock inventory..."})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-7 gap-4",children:[e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"w-8 h-8 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Items"}),e.jsx("p",{className:"text-2xl font-bold text-gray-800 dark:text-white",children:Q.totalItems})]})]})}),e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(X,{className:"w-8 h-8 text-yellow-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Low Stock"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:Q.lowStockItems})]})]})}),e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ne,{className:"w-8 h-8 text-red-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Out of Stock"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:Q.outOfStockItems})]})]})}),e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{className:"w-8 h-8 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Total Value"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["â‚¹",Q.totalValue.toLocaleString()]})]})]})}),e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(le,{className:"w-8 h-8 text-purple-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Recent Activity"}),e.jsx("p",{className:"text-2xl font-bold text-purple-600",children:Q.recentMovements})]})]})}),e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(K,{className:"w-8 h-8 text-indigo-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Existing Stock"}),e.jsx("p",{className:"text-2xl font-bold text-indigo-600",children:Q.existingStockItems})]})]})}),e.jsx(I,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(re,{className:"w-8 h-8 text-cyan-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Materials"}),e.jsx("p",{className:"text-2xl font-bold text-cyan-600",children:Q.materialsItems})]})]})})]}),e.jsxs(I,{children:[e.jsxs("div",{className:"p-4 border-b dark:border-gray-700",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"ğŸ“‹ Unified Stock Inventory"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Combined view of existing stock and materials inventory"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(U,{onClick:g,variant:"outline",size:"sm",children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),"Refresh"]}),e.jsxs(U,{onClick:oe,variant:"outline",size:"sm",children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"Export CSV"]}),e.jsxs(U,{variant:"outline",size:"sm",children:[e.jsx(ve,{className:"w-4 h-4 mr-1"}),"Print Labels"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"}),e.jsx($,{id:"search-stock",placeholder:"Search items...",value:q,onChange:a=>O(a.target.value),className:"pl-10"})]}),e.jsx(P,{id:"source-filter",label:"",options:[{value:"existing_stock",label:"Existing Stock"},{value:"materials",label:"Materials"}],value:M,onChange:a=>D(a.target.value),placeholder:"All Sources"}),e.jsx(P,{id:"category-filter",label:"",options:T.categories,value:l,onChange:a=>k(a.target.value),placeholder:"All Categories"}),e.jsx(P,{id:"status-filter",label:"",options:[{value:"in_stock",label:"In Stock"},{value:"low_stock",label:"Low Stock"},{value:"out_of_stock",label:"Out of Stock"}],value:b,onChange:a=>f(a.target.value),placeholder:"All Status"}),e.jsx(P,{id:"location-filter",label:"",options:T.locations,value:j,onChange:a=>E(a.target.value),placeholder:"All Locations"}),e.jsx(U,{variant:"outline",onClick:()=>{O(""),k(""),f(""),E(""),D("")},children:"Clear Filters"})]})]}),e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600",onClick:()=>{t("item_name"),p(F==="item_name"&&S==="asc"?"desc":"asc")},children:"Item Name"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Source"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Category"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600",onClick:()=>{t("balance"),p(F==="balance"&&S==="desc"?"asc":"desc")},children:"Current Stock"}),e.jsx("th",{className:"px-4 py-3 text-center font-medium",children:"Stock Level"}),e.jsx("th",{className:"px-4 py-3 text-center font-medium",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Location"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium",children:"Value"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Last Updated"}),e.jsx("th",{className:"px-4 py-3 text-center font-medium",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 dark:divide-gray-700",children:z.map(a=>{const o=B(a.stock_status),i=ie(a);return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:a.item_name}),e.jsxs("div",{className:"text-xs text-gray-500",children:[a.unit_of_measurement,a.supplier_name&&` â€¢ ${a.supplier_name}`]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${a.source==="existing_stock"?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300":"bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300"}`,children:a.source==="existing_stock"?"Existing":"Materials"})}),e.jsx("td",{className:"px-4 py-3 text-gray-700 dark:text-gray-300",children:a.category}),e.jsxs("td",{className:"px-4 py-3 text-right",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:a.balance}),a.minimum_threshold>0&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Min: ",a.minimum_threshold]})]}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:`h-2 rounded-full ${i>50?"bg-green-500":i>20?"bg-yellow-500":"bg-red-500"}`,style:{width:`${Math.max(i,5)}%`}})}),e.jsxs("div",{className:"text-xs text-center mt-1",children:[i.toFixed(0),"%"]})]}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${o.bgColor} ${o.color}`,children:a.stock_status.replace("_"," ")})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ke,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:a.storage_location})]})}),e.jsxs("td",{className:"px-4 py-3 text-right font-medium text-green-600",children:["â‚¹",a.total_value.toLocaleString()]}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:new Date(a.last_updated).toLocaleDateString()})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(U,{variant:"ghost",size:"sm",onClick:()=>{N(a),s(!0)},title:"Update Quantity",children:e.jsx(Se,{className:"w-4 h-4"})}),e.jsx(U,{variant:"ghost",size:"sm",title:"View History",children:e.jsx(we,{className:"w-4 h-4"})}),e.jsx(U,{variant:"ghost",size:"sm",title:"Mark for Reorder",children:e.jsx(Ce,{className:"w-4 h-4"})})]})})]},a.id)})})]}),z.length===0&&e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(K,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No stock items found matching your filters."})]})]})]}),e.jsx(be,{isOpen:m,onClose:()=>s(!1),title:`Update Stock - ${c==null?void 0:c.item_name}`,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:[e.jsx("strong",{children:"Current Stock:"})," ",c==null?void 0:c.balance," ",c==null?void 0:c.unit_of_measurement]}),e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300 mt-1",children:[e.jsx("strong",{children:"Source:"})," ",(c==null?void 0:c.source)==="existing_stock"?"Existing Stock":"Materials Inventory"]}),(c==null?void 0:c.minimum_threshold)&&c.minimum_threshold>0&&e.jsxs("p",{className:"text-sm text-blue-700 dark:text-blue-300",children:[e.jsx("strong",{children:"Minimum Threshold:"})," ",c.minimum_threshold," ",c.unit_of_measurement]})]}),e.jsx(P,{id:"update-type",label:"Update Type",value:u,onChange:a=>C(a.target.value),options:[{value:"add",label:"Add to Stock"},{value:"subtract",label:"Remove from Stock"},{value:"set",label:"Set Exact Amount"}]}),e.jsx($,{id:"update-quantity",label:"Quantity",type:"number",value:d,onChange:a=>h(a.target.value),placeholder:"Enter quantity"}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx(U,{variant:"outline",onClick:()=>s(!1),children:"Cancel"}),e.jsx(U,{onClick:ce,disabled:!d,children:"Update Stock"})]})]})})]})},et=()=>e.jsxs("div",{className:"space-y-6 px-4 py-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-800 dark:text-white mb-2",children:"ğŸ“¦ Existing Stock Management"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm sm:text-base",children:"Comprehensive view and management of your current inventory. Track usage, monitor levels, and maintain stock records."}),e.jsxs("div",{className:"mt-3 text-xs text-gray-500 dark:text-gray-400",children:[e.jsx("span",{className:"inline-block mr-4",children:"ğŸ“Š Unified Inventory View"}),e.jsx("span",{className:"inline-block mr-4",children:"ğŸ“¤ Usage Tracking"}),e.jsx("span",{className:"inline-block mr-4",children:"â• Add New Items"}),e.jsx("span",{className:"inline-block",children:"ğŸ“… Transaction History"})]})]}),e.jsx(De,{}),e.jsx(Ue,{}),"        ",e.jsx(Te,{}),"           ",e.jsx(qe,{}),"        "]});export{et as default};
